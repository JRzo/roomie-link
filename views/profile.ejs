<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomie Link - Filtered Users</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@latest/dist/full.css" rel="stylesheet" type="text/css" />
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
    <div class="grid grid-cols-1 lg:grid-cols-5 grid-rows-auto h-screen">
        <div class="col-span-5 bg-base-200 shadow-md flex items-center justify-between p-4">
            <div class="flex items-center">
                <div class="avatar">
                    <div class="w-36 rounded-full">
                        <img src="/img/rl.svg" alt="Roomie-Link Image" id="imageRL">
                    </div>
                </div>

            </div>
            <ul class="menu menu-horizontal px-10">
                <li><a href="/profile" class="font-permanent-marker text-xl">Dashboard</a></li>
                <li><a href="/application" class="font-permanent-marker text-xl">Application</a></li>
            </ul>
        </div>

        <div class="lg:col-span-1 bg-base-100 shadow-md p-4 flex flex-col">
            <ul class="menu w-full">
                <li class="font-permanent-marker text-lg">
                    <a href="/jobSearch">
                        Job Search
                    </a>
                </li>
                <li class="menu-item">
                    <details>
                        <summary class="font-permanent-marker text-lg">
                            <i class="fa fa-gear mr-2"></i> Settings
                        </summary>
                        <ul>
                            <li><a href="/personalUser">Profile</a></li>
                            <li><a href="/logout">Log Out
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
                                </svg>
                            </a></li>
                            <li>
                                <form action="/d/deleteAccount" method="POST" onsubmit="return confirm('Are you sure you want to delete your account?');">
                                    <input type="hidden" name="_method" value="DELETE">
                                    <button type="submit" class="btn btn-ghost w-full justify-start">Delete Account</button>
                                </form>
                            </li>
                        </ul>
                    </details>
                </li>
                <li class="mt-8">
                    <select class="select select-bordered w-full max-w-xs" id="theme-dropdown">
                        <option disabled selected>Select Theme</option>
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="cupcake">Cupcake</option>
                        <option value="bumblebee">Bumblebee</option>
                        <option value="emerald">Emerald</option>
                        <option value="corporate">Corporate</option>
                        <option value="synthwave">Synthwave</option>
                        <option value="retro">Retro</option>
                        <option value="cyberpunk">Cyberpunk</option>
                        <option value="valentine">Valentine</option>
                        <option value="halloween">Halloween</option>
                        <option value="garden">Garden</option>
                        <option value="forest">Forest</option>
                        <option value="aqua">Aqua</option>
                        <option value="lofi">Lofi</option>
                        <option value="pastel">Pastel</option>
                        <option value="fantasy">Fantasy</option>
                        <option value="wireframe">Wireframe</option>
                        <option value="black">Black</option>
                        <option value="luxury">Luxury</option>
                        <option value="dracula">Dracula</option>
                        <option value="cmyk">CMYK</option>
                        <option value="autumn">Autumn</option>
                        <option value="business">Business</option>
                        <option value="acid">Acid</option>
                        <option value="lemonade">Lemonade</option>
                        <option value="night">Night</option>
                        <option value="coffee">Coffee</option>
                        <option value="winter">Winter</option>
                    </select>
                </li>
            </ul>

            <div class="divider font-permanent-marker text-lg mt-8"></div>
            <details class="collapse collapse-arrow bg-base-200 mb-4">
                <summary class="collapse-title text-xl font-permanent-marker">
                    <i class="fa fa-filter mr-2"></i> Apply Filters
                </summary>
                <div class="collapse-content bg-base-100 p-4 space-y-4">
                    <form action="/post/applyPreferenceFilter" method="POST" class="space-y-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">College:</span>
                            </label>
                            <input type="text" name="college" placeholder="e.g., Harvard College" class="input input-bordered w-full" value="<%= typeof filters !== 'undefined' && filters.college ? filters.college : '' %>" />
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Major:</span>
                            </label>
                            <input type="text" name="major" placeholder="e.g., Computer Science" class="input input-bordered w-full" value="<%= typeof filters !== 'undefined' && filters.major ? filters.major : '' %>" />
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Sex:</span>
                            </label>
                            <select name="sex" class="select select-bordered w-full">
                                <option value="">Any</option>
                                <option value="Male" <%= typeof filters !== 'undefined' && filters.sex === 'Male' ? 'selected' : '' %>>Male</option>
                                <option value="Female" <%= typeof filters !== 'undefined' && filters.sex === 'Female' ? 'selected' : '' %>>Female</option>
                                <option value="Other" <%= typeof filters !== 'undefined' && filters.sex === 'Other' ? 'selected' : '' %>>Other</option>
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Graduation Year:</span>
                            </label>
                            <select name="year" class="select select-bordered w-full">
                                <option value="">Any</option>
                                <%
                                    const currentYear = new Date().getFullYear();
                                    const startYear = currentYear - 5; // Go back 5 years
                                    const endYear = currentYear + 5;    // Go forward 5 years
                                    for (let y = startYear; y <= endYear; y++) {
                                %>
                                        <option value="<%= y %>" <%= typeof filters !== 'undefined' && filters.year == y ? 'selected' : '' %>><%= y %></option>
                                <%
                                    }
                                %>
                            </select>
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Category:</span>
                            </label>
                            <select name="category" class="select select-bordered w-full">
                                <option value="">Any</option>
                                <option value="Undergraduate" <%= typeof filters !== 'undefined' && filters.category === 'Undergraduate' ? 'selected' : '' %>>Undergraduate</option>
                                <option value="Graduate" <%= typeof filters !== 'undefined' && filters.category === 'Graduate' ? 'selected' : '' %>>Graduate</option>
                                <option value="PhD" <%= typeof filters !== 'undefined' && filters.category === 'PhD' ? 'selected' : '' %>>PhD</option>
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer">
                                <span class="label-text">Has Instagram:</span>
                                <input type="checkbox" name="hasInstagram" class="checkbox" <%= typeof filters !== 'undefined' && filters.hasInstagram ? 'checked' : '' %>/>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Hobbies (comma-separated):</span>
                            </label>
                            <input type=--"text" name="hobbies" placeholder="e.g., reading, hiking" class="input input-bordered w-full" value="<%= typeof filters !== 'undefined' && filters.hobbies ? filters.hobbies.join(', ') : '' %>" />
                        </div>

                        <button type="submit" class="btn btn-primary w-full mt-4">Apply Filters</button>
                        <a href="/preferences" class="btn btn-secondary btn-outline w-full mt-2">Clear Filters</a>
                    </form>
                </div>
            </details>
        </div>

        <div class="lg:col-span-4 bg-base-300 p-6 flex flex-col gap-4 overflow-y-auto">

            <% if (users && users.length > 0) { %>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <% for(var i=0; i< users.length; i++) {%>
                        <div class="card bg-base-100 shadow-xl compact h-full flex flex-col">
                            <figure class="px-6 pt-6">
                                <img src="<%= users[i].profileImage || 'https://www.w3schools.com/bootstrap4/img_avatar1.png' %>" alt="Avatar" class="rounded-box w-full h-40 object-cover"/>
                            </figure>
                            <div class="card-body p-4 flex-grow">
                                <h2 class="card-title text-lg mb-1"><%= users[i].email || 'No Email' %></h2>
                                <p class="text-sm text-gray-600">
                                    <%= users[i].hobbies && users[i].hobbies.length > 0 ? 'Hobbies: ' + users[i].hobbies : 'No hobbies listed.' %>
                                </p>
                                <ul class="list-none p-0 text-sm mt-2 space-y-1">
                                    <li><strong>College:</strong> <%= users[i].college || 'N/A' %></li>
                                    <li><strong>Major:</strong> <%= users[i].major || 'N/A' %></li>
                                    <li><strong>Sex:</strong> <%= users[i].sex || 'N/A' %></li>
                                    <li><strong>Year:</strong> <%= users[i].year || 'N/A' %></li>
                                    <li><strong>Category:</strong> <%= users[i].category || 'N/A' %></li>
                                    <li><strong>Instagram:</strong> <%= users[i].social ? 'Yes' : 'No' %></li>
                                </ul>
                            </div>
                            <div class="card-actions p-4 flex justify-between items-center border-t border-base-200">
<form action="/post/sendMatchRequest/<%= users[i]._id %>" method="POST" class="flex-grow mr-2"
      onsubmit="handleMatchRequest(event, this)">
    <button type="submit" class="btn btn-primary btn-sm w-full">Match</button>
</form>
                                <% if (users[i].social) { %>
                                    <a href="<%= users[i].social %>" target="_blank" rel="noopener noreferrer" class="btn btn-ghost btn-circle btn-sm">
                                        <svg class="w-6 h-6" viewBox="0 0 72 72" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        </svg>
                                    </a>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                </div>
            <% } else { %>
                <p class="text-center text-lg text-gray-600">No users found matching your filter preferences.</p>
            <% } %>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const themeDropdown = document.getElementById('theme-dropdown');

            themeDropdown.addEventListener('change', (event) => {
                document.documentElement.setAttribute('data-theme', event.target.value);
                localStorage.setItem('theme', event.target.value); // Optional: Save theme to local storage
            });
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                themeDropdown.value = savedTheme;
            }


            const filterForm = document.querySelector('form[action="/post/applyPreferenceFilter"]');
            const filterDetails = filterForm.closest('details');


            const isFilterApplied = Array.from(filterForm.elements).some(element => {
                if (element.name === 'college' || element.name === 'major' || element.name === 'hobbies') {
                    return element.value.trim() !== '';
                }
                if (element.tagName === 'SELECT' && element.value === '') {
                    return false;
                }
                if (element.type === 'checkbox') {
                    return element.checked;
                }
                if (element.type === 'number') {
                    return element.value !== '';
                }
                return false;
            });

            if (isFilterApplied && filterDetails) {
                filterDetails.open = true;
            }
        });

         async function handleMatchRequest(event, form) {
        event.preventDefault(); // Prevent the default form submission

        try {
            const response = await fetch(form.action, {
                method: 'POST',
            });

            const data = await response.json();

            if (data.success) {
                // Optionally provide visual feedback to the user (e.g., change the button text/state)
                const button = form.querySelector('button');
                if (button) {
                    button.textContent = 'Request Sent';
                    button.disabled = true;
                }
                console.log('Match request successful:', data.message);
            } else {
                console.error('Match request failed:', data.message);
                alert(data.message); // Or display an error message in the UI
            }
        } catch (error) {
            console.error('There was an error sending the match request:', error);
            alert('An unexpected error occurred.');
        }
    }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/profile.js"></script>
</body>
</html>